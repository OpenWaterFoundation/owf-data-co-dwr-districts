StartLog(LogFile="results/02-upload-dataset-to-s3.tstool.log")
# Upload the Colorado DWR districts dataset to the Open Water Foundation's
# data.openwaterfoundation.org website.
#
# Define controlling properties:
# - InsertsFolder is the location of data.openwaterfoundation.org inserts for the landing page
SetProperty(PropertyName="InsertsFolder",PropertyType=String,PropertyValue="../../owf-website-data/inserts")
#
# Upload the files:
# - geojson file output by GeoProcessor
# - dataset metadata files needed for landing page
AwsS3(S3Command="UploadObjects",Region="us-west-2",Bucket="data.openwaterfoundation.org",UploadFiles="../data/co-dwr-districts.geojson:state/co/dwr/districts/co-dwr-districts.geojson,dataset.json:state/co/dwr/districts/dataset.json,dataset.png:state/co/dwr/districts/dataset.png,dataset-details.md:state/co/dwr/districts/dataset-details.md,../data/co-dwr-districts-division1.geojson:state/co/dwr/districts/co-dwr-districts-division1.geojson,../data/co-dwr-districts-division2.geojson:state/co/dwr/districts/co-dwr-districts-division2.geojson,../data/co-dwr-districts-division3.geojson:state/co/dwr/districts/co-dwr-districts-division3.geojson,../data/co-dwr-districts-division4.geojson:state/co/dwr/districts/co-dwr-districts-division4.geojson,../data/co-dwr-districts-division5.geojson:state/co/dwr/districts/co-dwr-districts-division5.geojson,../data/co-dwr-districts-division6.geojson:state/co/dwr/districts/co-dwr-districts-division6.geojson,../data/co-dwr-districts-division7.geojson:state/co/dwr/districts/co-dwr-districts-division7.geojson,../data/co-dwr-district-1.geojson:state/co/dwr/districts/co-dwr-district-1.geojson,../data/co-dwr-district-2.geojson:state/co/dwr/districts/co-dwr-district-2.geojson,../data/co-dwr-district-3.geojson:state/co/dwr/districts/co-dwr-district-3.geojson,../data/co-dwr-district-4.geojson:state/co/dwr/districts/co-dwr-district-4.geojson,../data/co-dwr-district-5.geojson:state/co/dwr/districts/co-dwr-district-5.geojson,../data/co-dwr-district-6.geojson:state/co/dwr/districts/co-dwr-district-6.geojson,../data/co-dwr-district-7.geojson:state/co/dwr/districts/co-dwr-district-7.geojson,../data/co-dwr-district-8.geojson:state/co/dwr/districts/co-dwr-district-8.geojson,../data/co-dwr-district-9.geojson:state/co/dwr/districts/co-dwr-district-9.geojson,../data/co-dwr-district-10.geojson:state/co/dwr/districts/co-dwr-district-10.geojson,../data/co-dwr-district-11.geojson:state/co/dwr/districts/co-dwr-district-11.geojson,../data/co-dwr-district-12.geojson:state/co/dwr/districts/co-dwr-district-12.geojson,../data/co-dwr-district-13.geojson:state/co/dwr/districts/co-dwr-district-13.geojson,../data/co-dwr-district-14.geojson:state/co/dwr/districts/co-dwr-district-14.geojson,../data/co-dwr-district-15.geojson:state/co/dwr/districts/co-dwr-district-15.geojson,../data/co-dwr-district-16.geojson:state/co/dwr/districts/co-dwr-district-16.geojson,../data/co-dwr-district-17.geojson:state/co/dwr/districts/co-dwr-district-17.geojson,../data/co-dwr-district-18.geojson:state/co/dwr/districts/co-dwr-district-18.geojson,../data/co-dwr-district-19.geojson:state/co/dwr/districts/co-dwr-district-19.geojson,../data/co-dwr-district-20.geojson:state/co/dwr/districts/co-dwr-district-20.geojson,../data/co-dwr-district-21.geojson:state/co/dwr/districts/co-dwr-district-21.geojson,../data/co-dwr-district-22.geojson:state/co/dwr/districts/co-dwr-district-22.geojson,../data/co-dwr-district-23.geojson:state/co/dwr/districts/co-dwr-district-23.geojson,../data/co-dwr-district-24.geojson:state/co/dwr/districts/co-dwr-district-24.geojson,../data/co-dwr-district-25.geojson:state/co/dwr/districts/co-dwr-district-25.geojson,../data/co-dwr-district-26.geojson:state/co/dwr/districts/co-dwr-district-26.geojson,../data/co-dwr-district-27.geojson:state/co/dwr/districts/co-dwr-district-27.geojson,../data/co-dwr-district-28.geojson:state/co/dwr/districts/co-dwr-district-28.geojson,../data/co-dwr-district-29.geojson:state/co/dwr/districts/co-dwr-district-29.geojson,../data/co-dwr-district-30.geojson:state/co/dwr/districts/co-dwr-district-30.geojson,../data/co-dwr-district-31.geojson:state/co/dwr/districts/co-dwr-district-31.geojson,../data/co-dwr-district-32.geojson:state/co/dwr/districts/co-dwr-district-32.geojson,../data/co-dwr-district-33.geojson:state/co/dwr/districts/co-dwr-district-33.geojson,../data/co-dwr-district-34.geojson:state/co/dwr/districts/co-dwr-district-34.geojson,../data/co-dwr-district-35.geojson:state/co/dwr/districts/co-dwr-district-35.geojson,../data/co-dwr-district-36.geojson:state/co/dwr/districts/co-dwr-district-36.geojson,../data/co-dwr-district-37.geojson:state/co/dwr/districts/co-dwr-district-37.geojson,../data/co-dwr-district-38.geojson:state/co/dwr/districts/co-dwr-district-38.geojson,../data/co-dwr-district-39.geojson:state/co/dwr/districts/co-dwr-district-39.geojson,../data/co-dwr-district-40.geojson:state/co/dwr/districts/co-dwr-district-40.geojson,../data/co-dwr-district-41.geojson:state/co/dwr/districts/co-dwr-district-41.geojson,../data/co-dwr-district-42.geojson:state/co/dwr/districts/co-dwr-district-42.geojson,../data/co-dwr-district-43.geojson:state/co/dwr/districts/co-dwr-district-43.geojson,../data/co-dwr-district-44.geojson:state/co/dwr/districts/co-dwr-district-44.geojson,../data/co-dwr-district-45.geojson:state/co/dwr/districts/co-dwr-district-45.geojson,../data/co-dwr-district-46.geojson:state/co/dwr/districts/co-dwr-district-46.geojson,../data/co-dwr-district-47.geojson:state/co/dwr/districts/co-dwr-district-47.geojson,../data/co-dwr-district-48.geojson:state/co/dwr/districts/co-dwr-district-48.geojson,../data/co-dwr-district-49.geojson:state/co/dwr/districts/co-dwr-district-49.geojson,../data/co-dwr-district-50.geojson:state/co/dwr/districts/co-dwr-district-50.geojson,../data/co-dwr-district-51.geojson:state/co/dwr/districts/co-dwr-district-51.geojson,../data/co-dwr-district-52.geojson:state/co/dwr/districts/co-dwr-district-52.geojson,../data/co-dwr-district-53.geojson:state/co/dwr/districts/co-dwr-district-53.geojson,../data/co-dwr-district-54.geojson:state/co/dwr/districts/co-dwr-district-54.geojson,../data/co-dwr-district-55.geojson:state/co/dwr/districts/co-dwr-district-55.geojson,../data/co-dwr-district-56.geojson:state/co/dwr/districts/co-dwr-district-56.geojson,../data/co-dwr-district-57.geojson:state/co/dwr/districts/co-dwr-district-57.geojson,../data/co-dwr-district-58.geojson:state/co/dwr/districts/co-dwr-district-58.geojson,../data/co-dwr-district-59.geojson:state/co/dwr/districts/co-dwr-district-59.geojson,../data/co-dwr-district-60.geojson:state/co/dwr/districts/co-dwr-district-60.geojson,../data/co-dwr-district-61.geojson:state/co/dwr/districts/co-dwr-district-61.geojson,../data/co-dwr-district-62.geojson:state/co/dwr/districts/co-dwr-district-62.geojson,../data/co-dwr-district-63.geojson:state/co/dwr/districts/co-dwr-district-63.geojson,../data/co-dwr-district-64.geojson:state/co/dwr/districts/co-dwr-district-64.geojson,../data/co-dwr-district-65.geojson:state/co/dwr/districts/co-dwr-district-65.geojson,../data/co-dwr-district-66.geojson:state/co/dwr/districts/co-dwr-district-66.geojson,../data/co-dwr-district-67.geojson:state/co/dwr/districts/co-dwr-district-67.geojson,../data/co-dwr-district-68.geojson:state/co/dwr/districts/co-dwr-district-68.geojson,../data/co-dwr-district-69.geojson:state/co/dwr/districts/co-dwr-district-69.geojson,../data/co-dwr-district-70.geojson:state/co/dwr/districts/co-dwr-district-70.geojson,../data/co-dwr-district-71.geojson:state/co/dwr/districts/co-dwr-district-71.geojson,../data/co-dwr-district-72.geojson:state/co/dwr/districts/co-dwr-district-72.geojson,../data/co-dwr-district-73.geojson:state/co/dwr/districts/co-dwr-district-73.geojson,../data/co-dwr-district-76.geojson:state/co/dwr/districts/co-dwr-district-76.geojson,../data/co-dwr-district-77.geojson:state/co/dwr/districts/co-dwr-district-77.geojson,../data/co-dwr-district-78.geojson:state/co/dwr/districts/co-dwr-district-78.geojson,../data/co-dwr-district-79.geojson:state/co/dwr/districts/co-dwr-district-79.geojson,../data/co-dwr-district-80.geojson:state/co/dwr/districts/co-dwr-district-80.geojson")
#
# Invalidate so that files are available on the CDN as soon as possible.
# AwsCloudFront(CloudFrontCommand="ListDistributions",Region="aws-global",Comment="*data.openwaterfoundation.org*",OutputTableID="Distributions")
AwsCloudFront(CloudFrontCommand="InvalidateDistribution",Region="aws-global",Comment="*data.openwaterfoundation.org*",InvalidationPaths="/state/co/dwr/districts/*")
#
# Create the dataset catalog with landing page:
# - also list invalidations to see what is in process
AwsS3Catalog(Region="us-west-2",Bucket="data.openwaterfoundation.org",StartingPrefix="state/co/dwr/districts/",DistributionId="*data.openwaterfoundation.org*",DatasetIndexFile="results/dataset-index.html",DatasetIndexHeadFile="${InsertsFolder}/head-insert.html",DatasetIndexBodyFile="${InsertsFolder}/body-nav-insert.html",DatasetIndexFooterFile="${InsertsFolder}/footer-insert.html",UploadDatasetFiles=True,OutputTableID="Datasets",KeepFiles=True)
# AwsCloudFront(CloudFrontCommand="ListInvalidations",Region="af-south-1",OutputTableID="InvalidationList")
# Compare the local and S3 file to see how long it takes to be avaialable on S3.
CompareFiles(InputFile1="results/dataset-index.html",InputFile2="https://s3.us-west-2.amazonaws.com/data.openwaterfoundation.org/state/co/dwr/districts/index.html",IfDifferent=Warn,WaitUntil=FilesAreSame,WaitTimeout=600000,WaitInterval=60000)
# Compare the local and CloudFront file to see how long it takes to be avaialable on CloudFront.
CompareFiles(InputFile1="results/dataset-index.html",InputFile2="https://data.openwaterfoundation.org/state/co/dwr/districts/index.html",IfDifferent=Warn,WaitUntil=FilesAreSame,WaitTimeout=600000,WaitInterval=60000)
# Compare the index.html and folder name URLs to make sure that all variants were invalidated:
# - the AWS configuration should automatically add index.html to folders
CompareFiles(InputFile1="https://data.openwaterfoundation.org/state/co/dwr/districts/index.html",InputFile2="https://data.openwaterfoundation.org/state/co/dwr/districts/",IfDifferent=Warn,WaitUntil=FilesAreSame,WaitTimeout=600000,WaitInterval=60000)
CompareFiles(InputFile1="https://data.openwaterfoundation.org/state/co/dwr/districts/index.html",InputFile2="https://data.openwaterfoundation.org/state/co/dwr/districts",IfDifferent=Warn,WaitUntil=FilesAreSame,WaitTimeout=600000,WaitInterval=60000)
